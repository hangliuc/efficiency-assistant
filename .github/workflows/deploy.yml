name: Deploy Finance Bot

on:
  push:
    branches: [ "master" ]
    paths-ignore:   # å¿½ç•¥ä¸å½±å“è¿è¡Œçš„æ–‡ä»¶ï¼Œé¿å…æ— æ„ä¹‰çš„æ„å»º
      - 'README.md'
      - 'finance.md'
      - '.gitignore'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync files to server
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          # ARGS è¯´æ˜:
          # -avzr: å½’æ¡£æ¨¡å¼ã€è¯¦ç»†ã€å‹ç¼©ã€é€’å½’
          # --delete: [å…³é”®] åˆ é™¤æœåŠ¡å™¨ä¸Šæœ‰ä½†ä»£ç åº“é‡Œæ²¡æœ‰çš„æ–‡ä»¶
          # --exclude='data/': [å…³é”®] æ’é™¤ data ç›®å½•ï¼Œé˜²æ­¢æŠŠæœåŠ¡å™¨ä¸Šçš„åŸºå‡†ä»· json æ–‡ä»¶åˆ äº†
          # --exclude='.git/': æ’é™¤ git ç›®å½•
          # --exclude='venv/': æ’é™¤è™šæ‹Ÿç¯å¢ƒ
          ARGS: "-avzr --delete  --exclude='.git/'"
          SOURCE: "."
          REMOTE_HOST: ${{ secrets.SERVER_HOST }}
          REMOTE_USER: "root"
          TARGET: "/root/lh-wx-helper/" 

      # 2. è¿œç¨‹æ‰§è¡Œ Docker æ„å»ºä¸é‡å¯
      - name: Build and Restart Docker
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting Deployment..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /root/lh-wx-helper
            
            # 1. æ„å»ºæ–°é•œåƒ (è¦†ç›– latest æ ‡ç­¾)
            echo "ğŸ”¨ Building Docker Image..."
            docker build -t lh-wx-helper:latest .
            
            # 2. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ (å¦‚æœå­˜åœ¨)
            echo "ğŸ›‘ Stopping old container..."
            docker rm -f lh-wx-helper || true
            
            # 3. å¯åŠ¨æ–°å®¹å™¨
            echo "â–¶ï¸ Starting new container..."
            docker run -d \
              --name lh-wx-helper \
              --restart always \
              -v $(pwd)/config:/app/config \
              -e TZ=Asia/Shanghai \
              lh-wx-helper:latest
            
            echo "âœ… Deployment Finished. å…¨é‡ä»£ç åŒæ­¥å®Œæˆï¼"