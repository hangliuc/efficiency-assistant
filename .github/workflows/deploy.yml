name: Deploy Finance Bot

on:
  push:
    branches: [ "master" ]
    paths-ignore:   # å¿½ç•¥ä¸å½±å“è¿è¡Œçš„æ–‡ä»¶ï¼Œé¿å…æ— æ„ä¹‰çš„æ„å»º
      - 'README.md'
      - 'finance.md'
      - '.gitignore'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ä¼ è¾“æ‰€æœ‰æ–‡ä»¶åˆ°æœåŠ¡å™¨
      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # å…³é”®ä¿®æ”¹ï¼šsource: "." ä»£è¡¨ä¼ è¾“å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
          source: "."
          target: "/root/lh-wx-helper"
          # æ’é™¤ .git å’Œ .github æ–‡ä»¶å¤¹ï¼Œä¿æŒæœåŠ¡å™¨ç›®å½•æ¸…çˆ½
          exclude: ".git,.github"

      # 2. è¿œç¨‹æ‰§è¡Œ Docker æ„å»ºä¸é‡å¯
      - name: Build and Restart Docker
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting Deployment..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /root/lh-wx-helper
            
            # 1. æ„å»ºæ–°é•œåƒ (è¦†ç›– latest æ ‡ç­¾)
            echo "ğŸ”¨ Building Docker Image..."
            docker build -t lh-wx-helper:latest .
            
            # 2. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ (å¦‚æœå­˜åœ¨)
            echo "ğŸ›‘ Stopping old container..."
            docker rm -f lh-wx-helper || true
            
            # 3. å¯åŠ¨æ–°å®¹å™¨
            echo "â–¶ï¸ Starting new container..."
            docker run -d \
              --name lh-wx-helper \
              --restart always \
              -v $(pwd)/config:/app/config \
              -e TZ=Asia/Shanghai \
              lh-wx-helper:latest
            
            echo "âœ… Deployment Finished. å…¨é‡ä»£ç åŒæ­¥å®Œæˆï¼"